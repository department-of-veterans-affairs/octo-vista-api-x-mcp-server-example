[tools]
python = "3.12"
uv = "latest"

# Hook that runs after tools are installed
[hooks]
postinstall = "mise run _setup"

# Hidden helper tasks
[tasks._setup]
hide = true
run = "python scripts/setup.py"

[tasks._start-mock]
hide = true
dir = "mock_server"
env = { COMPOSE_PROJECT_NAME = "vista-mock" }
run = ["docker-compose up -d", "python ../scripts/check_mock_server.py"]

[tasks.stop-mock]
description = "Stop the mock server"
dir = "mock_server"
env = { COMPOSE_PROJECT_NAME = "vista-mock" }
run = ["docker-compose down", "echo '‚úÖ Mock server stopped'"]

[tasks.dev-with-mock]
description = "Start development with mock server (handles all setup)"
run = [
    # Auto-setup if needed
    "python scripts/silent_setup.py",
    # Start mock server if needed
    "python scripts/start_mock_if_needed.py",
    # Run MCP server with dev inspector
    "uv run mcp dev server.py:server",
]

[tasks.dev]
description = "Start development server"
run = [
    # Auto-setup if needed
    "python scripts/silent_setup.py",
    # Run MCP server
    "echo 'üèÉ Starting MCP server...'",
    "uv run mcp dev server.py:server",
]

# Utility tasks (optional)
[tasks.test]
description = "Run tests"
run = "uv run pytest"

[tasks.lint]
description = "Check code quality (format + lint + type check)"
run = ["uv run black .", "uv run ruff check --fix .", "uv run mypy ."]

[tasks.logs]
description = "View mock server logs"
dir = "mock_server"
env = { COMPOSE_PROJECT_NAME = "vista-mock" }
run = "docker-compose logs -f"

[tasks.setup-claude]
description = "Set up Claude Desktop configuration"
run = "python scripts/setup_claude_desktop.py"

# === NEW STREAMABLE HTTP TASKS ===
[tasks.dev-http]
description = "Start Streamable HTTP server for development (RECOMMENDED)"
env = { VISTA_MCP_TRANSPORT = "streamable-http" }
run = [
    # Auto-setup if needed
    "python scripts/silent_setup.py",
    # Start HTTP server in background and open inspector
    "echo 'üöÄ Starting Streamable HTTP server...'",
    "echo 'üìç MCP endpoint: http://localhost:8000/mcp'",
    "echo 'üéØ Opening MCP Inspector in 3 seconds...'",
    "echo ''",
    "echo 'üîß Configure your client with:'",
    "echo '  Transport: streamable-http'", 
    "echo '  URL: http://localhost:8000/mcp'",
    "echo ''",
    # Start server in background and then open inspector
    "uv run python http_server.py &",
    "sleep 3",
    "echo 'üé≠ Opening MCP Inspector...'",
    "npx @modelcontextprotocol/inspector",
]

[tasks.dev-http-with-mock]
description = "Start Streamable HTTP server with mock Vista API (RECOMMENDED)"
env = { VISTA_MCP_TRANSPORT = "streamable-http" }
run = [
    # Auto-setup if needed
    "python scripts/silent_setup.py",
    # Start mock server if needed
    "python scripts/start_mock_if_needed.py",
    # Start HTTP server in background and open inspector
    "echo 'üöÄ Starting Streamable HTTP server with mock...'",
    "echo 'üìç MCP endpoint: http://localhost:8000/mcp'",
    "echo 'üéØ Opening MCP Inspector in 5 seconds...'",
    "echo ''",
    "echo 'üîß Configure your client with:'",
    "echo '  Transport: streamable-http'",
    "echo '  URL: http://localhost:8000/mcp'",
    "echo ''",
    # Start server in background and then open inspector
    "uv run python http_server.py &",
    "sleep 5", 
    "echo '‚è≥ Waiting for server to be ready...'",
    "echo 'üé≠ Opening MCP Inspector...'",
    "npx @modelcontextprotocol/inspector",
]

# Raw server tasks (without inspector)
[tasks.dev-http-server]
description = "Start Streamable HTTP server only (no inspector)"
env = { VISTA_MCP_TRANSPORT = "streamable-http" }
run = [
    "python scripts/silent_setup.py",
    "echo 'üöÄ Starting Streamable HTTP server...'",
    "echo 'üìç MCP endpoint: http://localhost:8000/mcp'",
    "echo 'üîß Connect manually with MCP Inspector:'",
    "echo '  npx @modelcontextprotocol/inspector'",
    "echo '  Transport: http, URL: http://localhost:8000/mcp'",
    "echo ''",
    "uv run python http_server.py",
]

[tasks.dev-http-server-with-mock]
description = "Start Streamable HTTP server with mock (no inspector)" 
env = { VISTA_MCP_TRANSPORT = "streamable-http" }
run = [
    "python scripts/silent_setup.py",
    "python scripts/start_mock_if_needed.py",
    "echo 'üöÄ Starting Streamable HTTP server with mock...'",
    "echo 'üìç MCP endpoint: http://localhost:8000/mcp'",
    "echo 'üîß Connect manually with MCP Inspector:'",
    "echo '  npx @modelcontextprotocol/inspector'",
    "echo '  Transport: http, URL: http://localhost:8000/mcp'",
    "echo ''",
    "uv run python http_server.py",
]

# === DEPRECATED SSE TASKS ===
[tasks.dev-sse]
description = "‚ö†Ô∏è  DEPRECATED: Start SSE server for development (use dev-http instead)"
env = { VISTA_MCP_TRANSPORT = "sse" }
run = [
    # Auto-setup if needed
    "python scripts/silent_setup.py",
    # Show deprecation warning
    "echo '‚ö†Ô∏è  WARNING: SSE transport is DEPRECATED!'",
    "echo '‚ö†Ô∏è  Please use \"mise run dev-http\" for better performance.'",
    "echo '‚ö†Ô∏è  SSE support will be removed on 2025-06-01'",
    "echo ''",
    # Run SSE server
    "echo 'üåê Starting SSE server...'",
    "echo 'üìç SSE endpoint: http://localhost:8000/sse'",
    "echo 'üìù Message endpoint: http://localhost:8000/messages/'",
    "echo ''",
    "echo 'üîß Configure your client with:'",
    "echo '  {\"url\": \"http://localhost:8000/sse\"}'",
    "echo ''",
    "uv run python http_server.py",
]

[tasks.dev-sse-with-mock]
description = "‚ö†Ô∏è  DEPRECATED: Start SSE server with mock Vista API (use dev-http-with-mock instead)"
env = { VISTA_MCP_TRANSPORT = "sse" }
run = [
    # Auto-setup if needed
    "python scripts/silent_setup.py",
    # Start mock server if needed
    "python scripts/start_mock_if_needed.py",
    # Show deprecation warning
    "echo '‚ö†Ô∏è  WARNING: SSE transport is DEPRECATED!'",
    "echo '‚ö†Ô∏è  Please use \"mise run dev-http-with-mock\" for better performance.'",
    "echo '‚ö†Ô∏è  SSE support will be removed on 2025-06-01'",
    "echo ''",
    # Run SSE server
    "echo 'üåê Starting SSE server with mock...'",
    "echo 'üìç SSE endpoint: http://localhost:8000/sse'",
    "echo 'üìù Message endpoint: http://localhost:8000/messages/'",
    "echo ''",
    "echo 'üîß Configure your client with:'",
    "echo '  {\"url\": \"http://localhost:8000/sse\"}'",
    "echo ''",
    "uv run python http_server.py",
]
